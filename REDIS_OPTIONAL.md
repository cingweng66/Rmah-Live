# Redis 可选部署说明

## 概述

Redis 在本系统中主要用于**缓存 License 验证结果**，以提高系统性能。**Redis 不是必需的**，系统已经实现了自动降级机制。

## 不使用 Redis 的影响

### ✅ 可以正常工作的功能

1. **所有核心功能**：游戏状态管理、用户认证、License 验证等
2. **数据库操作**：所有数据都存储在 PostgreSQL 中
3. **WebSocket 实时通信**：不依赖 Redis

### ⚠️ 潜在影响

1. **性能影响**：
   - License 验证会直接查询数据库，响应时间可能稍慢（通常 < 50ms）
   - 对于单实例部署，影响很小
   - 对于高并发场景，数据库查询会增加

2. **多实例部署**：
   - **重要**：如果部署多个后端实例（负载均衡），内存缓存不会在实例间共享
   - 每个实例都有自己的缓存，可能导致：
     - 缓存不一致（一个实例缓存了，另一个没有）
     - 缓存命中率降低
   - **解决方案**：多实例部署时建议使用 Redis

3. **缓存失效**：
   - 应用重启后，内存缓存会清空
   - 需要重新查询数据库建立缓存

## 系统降级机制

代码已经实现了完善的降级机制：

```typescript
// backend/src/app.module.ts
// 如果 Redis 连接失败，自动使用内存缓存
if (store) {
  return { store: () => store, ttl: 3600 * 1000 };
} else {
  return { ttl: 3600 * 1000 }; // 内存缓存
}
```

### 降级流程

1. 尝试连接 Redis（最多 3 次重试）
2. 如果连接失败，自动切换到内存缓存
3. 系统继续正常运行，只是使用内存缓存

## 部署选项

### 选项 1：不使用 Redis（推荐用于单实例）

**优点**：
- 节省成本（Azure Redis 需要付费）
- 简化部署流程
- 单实例性能影响很小

**缺点**：
- 多实例时缓存不共享
- 应用重启后缓存丢失

**适用场景**：
- 单实例部署
- 低到中等并发
- 预算有限

### 选项 2：使用 Redis（推荐用于生产环境）

**优点**：
- 缓存共享（多实例部署）
- 更好的性能（减少数据库查询）
- 缓存持久化（应用重启不丢失）

**缺点**：
- 需要额外成本（Azure Redis Basic 约 $15-20/月）
- 需要管理 Redis 实例

**适用场景**：
- 多实例/负载均衡部署
- 高并发场景
- 生产环境

## 修改说明

### 1. 部署脚本修改

`deploy-azure.sh` 已经修改为：
- Redis 部署变为可选
- 如果选择不部署，环境变量中 `REDIS_HOST` 设置为空字符串
- 系统会自动检测并使用内存缓存

### 2. 代码修改

`backend/src/app.module.ts` 已经修改为：
- 如果 `REDIS_HOST` 为空，直接使用内存缓存
- 不再尝试连接 Redis

## 使用建议

### 单实例部署
✅ **可以不使用 Redis**
- 性能影响很小
- 节省成本
- 简化运维

### 多实例部署
⚠️ **建议使用 Redis**
- 确保缓存一致性
- 提高缓存命中率
- 更好的性能

### 开发/测试环境
✅ **可以不使用 Redis**
- 使用本地内存缓存即可
- 简化环境配置

## 后续添加 Redis

如果以后需要添加 Redis，可以：

1. 在 Azure Portal 中创建 Redis 实例
2. 更新 Web App 的环境变量：
   - `REDIS_HOST`: Redis 主机名:端口
   - `REDIS_PASSWORD`: Redis 密码
3. 重启应用，系统会自动连接到 Redis

## 监控建议

即使不使用 Redis，也建议监控：
- 数据库查询性能
- License 验证响应时间
- 应用内存使用情况

## 总结

**Redis 是可选的**，系统已经做好了降级准备。对于单实例部署，不使用 Redis 是完全可行的选择。
