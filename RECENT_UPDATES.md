# 最近更新 - 2026-01-13

## 更新概述

本次更新主要解决了三个关键问题：

1. **西家和北家照片显示问题** - 添加了详细的调试日志和改进了图片存储逻辑
2. **准确的日本麻将点数计算** - 实现了符合M-League标准的点数计算系统
3. **点数表格UI** - 提供了三种不同的结算方式供选择

## 详细更新内容

### 1. 照片显示问题修复

#### 问题分析
西家和北家的照片在直播界面无法正确显示。

#### 解决方案
- 添加了详细的调试日志到以下组件：
  - `DisplayView3.tsx` - 显示每个位置的图片状态
  - `DisplayView4.tsx` - 显示每个位置的图片状态
  - `PlayerControlCard.tsx` - 记录图片上传过程
  - `gameStore.ts` - 记录图片存储和广播过程

#### 调试信息
现在控制台会显示：
- 每个位置是否有图片
- 图片数据的大小
- 图片上传和存储的完整流程

#### 如何检查
1. 打开浏览器开发者工具 (F12)
2. 查看Console标签
3. 上传西家或北家的照片时，会看到详细的日志信息
4. 在直播界面刷新时，会显示每个位置的图片状态

---

### 2. 日本麻将点数计算系统

#### 新增功能：准确的点数计算

基于标准日本麻将规则实现了完整的点数计算系统：

##### 基础计算公式
```
基础点数 = 符数 × 2^(番数+2)
```

##### 荣和（Ron）点数
- **庄家**: 基础点数 × 6（向上取整至百位）
- **子家**: 基础点数 × 4（向上取整至百位）

##### 自摸（Tsumo）点数
- **庄家自摸**: 每人支付 基础点数 × 2
- **子家自摸**: 
  - 其他子家各支付 基础点数 × 1
  - 庄家支付 基础点数 × 2

##### 特殊役种限制
| 役种 | 番数 | 庄家荣和 | 子家荣和 | 庄家自摸(每人) | 子家自摸(子/庄) |
|------|------|----------|----------|----------------|-----------------|
| 满贯 | 5番 或 4番40符 或 3番70符 | 12,000 | 8,000 | 4,000 | 2,000 / 4,000 |
| 跳满 | 6-7番 | 18,000 | 12,000 | 6,000 | 3,000 / 6,000 |
| 倍满 | 8-10番 | 24,000 | 16,000 | 8,000 | 4,000 / 8,000 |
| 三倍满 | 11-12番 | 36,000 | 24,000 | 12,000 | 6,000 / 12,000 |
| 役满 | 13番+ | 48,000 | 32,000 | 16,000 | 8,000 / 16,000 |

---

### 3. 新的结算UI系统

#### 三种结算方式

控制面板的结算操作现在提供三种输入模式，可以通过顶部的按钮切换：

##### 方式一：快捷点数 (默认)
- 最常用的点数组合，一键选择
- **荣和（庄家）**: 1500, 2900, 5800, 7700, 12000
- **荣和（子家）**: 1000, 2000, 3900, 5200, 8000
- **自摸（庄家）**: 显示为 "500×3", "1000×3", "2000×3" 等
- **自摸（子家）**: 显示为 "300/500", "500/1000", "1000/2000" 等
  - 第一个数字是子家支付，第二个数字是庄家支付

##### 方式二：点数表
- 可视化的番符点数对照表
- **范围**: 1-4番，20-50符
- **特殊役种按钮**: 满贯、跳满、倍满、三倍满、役满
- 点击表格中的数字即可选定

**表格示例**（子家荣和）:
```
番/符    20符   25符   30符   40符   50符
1番      -      -     1000   1300   1600
2番     1300   1600   2000   2600   3200
3番     2600   3200   3900   5200   6400
4番     5200   6400   7700   8000   8000
```

##### 方式三：番符计算
- 手动输入番数和符数
- 自动计算对应的点数
- 实时显示计算结果

#### 使用说明

1. **选择胜者**: 下拉菜单选择获胜玩家（显示是否为庄家）
2. **选择和牌方式**: 荣和 或 自摸
3. **选择放铳者**（仅荣和）: 下拉菜单选择放铳玩家
4. **选择结算方式**: 
   - 点击"快捷点数"、"点数表"或"番符计算"切换输入模式
5. **输入点数**: 根据选择的方式输入或选择点数
6. **查看预览**: 底部会显示结算预览，包括：
   - 每个玩家当前分数
   - 分数变化（用颜色标识：绿色为增加，红色为减少）
   - 结算后的分数
7. **确认结算**: 点击"确认结算"按钮完成结算

---

### 4. 其他改进

#### 控制面板
- 添加了DisplayPublic4的访问地址显示
- 结算界面更加直观，清晰显示庄家/子家状态
- 本场和供托的处理更加准确

#### 直播界面
- 所有界面（DisplayPublic, DisplayPublic2, DisplayPublic3, DisplayPublic4）都已更新
- 改进了图片加载和显示逻辑
- 添加了详细的调试信息

---

## 测试建议

### 测试照片显示
1. 打开控制面板
2. 依次为东、南、西、北四个位置上传照片
3. 打开浏览器控制台查看日志
4. 打开直播界面（任意布局）
5. 检查所有四个位置的照片是否都能正确显示
6. 如果有问题，查看控制台中的调试信息

### 测试点数计算
1. 打开控制面板的"结算操作"区域
2. 尝试三种不同的结算方式：
   - **快捷点数**: 点击预设的点数按钮
   - **点数表**: 点击表格中的番符组合
   - **番符计算**: 手动输入番数和符数
3. 查看结算预览，确认点数计算正确
4. 测试不同情况：
   - 庄家荣和 vs 子家荣和
   - 庄家自摸 vs 子家自摸
   - 不同的番符组合
   - 特殊役种（满贯、跳满等）

### 对比M-League规则
可以参考以下标准点数进行对比：
- 1番30符子家荣和: 1000点 ✓
- 2番30符子家荣和: 2000点 ✓
- 3番30符子家荣和: 3900点 ✓
- 4番30符子家荣和: 7700点 ✓
- 满贯子家荣和: 8000点 ✓

---

## 已知问题和限制

1. **图片大小限制**: 每张图片限制为2MB，防止localStorage溢出
2. **浏览器兼容性**: 建议使用Chrome、Edge或Firefox的最新版本
3. **网络连接**: 需要稳定的网络连接以确保WebSocket实时同步

---

## 技术细节

### 新增文件
- `src/components/game/ScoringTable.tsx` - 点数表格组件

### 修改文件
- `src/components/game/ControlPanel.tsx` - 集成新的结算系统
- `src/components/game/DisplayView3.tsx` - 添加调试日志
- `src/components/game/DisplayView4.tsx` - 添加调试日志
- `src/components/game/PlayerControlCard.tsx` - 改进图片上传
- `src/store/gameStore.ts` - 改进状态管理和广播

### 点数计算实现
```typescript
// 基础点数计算
const basePoints = fu * Math.pow(2, han + 2);

// 荣和点数（向上取整至百位）
const ronPoints = Math.ceil((basePoints * multiplier) / 100) * 100;

// multiplier: 庄家=6, 子家=4
```

---

## 下一步计划

如果还有问题，可以考虑：
1. 添加图片压缩功能，进一步减小存储大小
2. 实现图片云存储，避免localStorage限制
3. 添加点数计算历史记录
4. 支持自定义点数表格设置

---

更新日期: 2026-01-13
版本: v2.1.0
